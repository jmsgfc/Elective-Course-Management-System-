-- 创建数据库
CREATE DATABASE IF NOT EXISTS studentoperation;
USE studentoperation;

-- ------------------------
-- 用户表（管理员、教师、学生）
-- ------------------------
CREATE TABLE users (
    uname CHAR(30) NOT NULL PRIMARY KEY, -- 账号：教师以00开头，学生以1开头（三位）
    pwd CHAR(30) NOT NULL,                -- 密码：教师统一123456，学生统一111222
    role INT NOT NULL            -- 角色：0=管理员，1=教师，2=学生
);

-- ------------------------
-- 课程表（cno自增优化）
-- ------------------------
CREATE TABLE courses (
    cno INT AUTO_INCREMENT PRIMARY KEY,   -- 使用INT类型自增主键
    cname VARCHAR(20) NOT NULL,           -- 课程名称
    credit INT NOT NULL,                  -- 学分
    max_come INT NOT NULL,                -- 最大选课人数
    cdate CHAR(15) NULL
);


-- ------------------------
-- 学生表（学号三位以1开头）
-- ------------------------
CREATE TABLE student (
    sno CHAR(25) NOT NULL PRIMARY KEY,  -- 学号：三位，如101、102
    sname CHAR(25) NOT NULL,            -- 姓名
    sex CHAR(10) DEFAULT '男',           -- 性别
    depart VARCHAR(30),                 -- 学院
    major CHAR(30),                     -- 专业
    sclass CHAR(30)                      -- 班级
);

-- ------------------------
-- 成绩表（优化：增加date列表示学期）
-- ------------------------
CREATE TABLE scores (
    cno INT NOT NULL,                   -- 关联courses表的自增ID
    sno CHAR(30) NOT NULL,              -- 学号
    grade INT,                         -- 成绩
    cdate CHAR(30) NOT NULL DEFAULT '2024-2025-1', -- 学期
    PRIMARY KEY (cno, sno),            -- 禁止同一学生重复选修同一课程
    FOREIGN KEY (cno) REFERENCES courses(cno),
    FOREIGN KEY (sno) REFERENCES student(sno)
);

-- ------------------------
-- 教师表（10位教师，随机姓名）
-- ------------------------
CREATE TABLE teacher (
    tno CHAR(30) NOT NULL PRIMARY KEY,  -- 教师编号：以00开头，如0001-0010
    tname CHAR(30) NOT NULL             -- 姓名：随机生成
);

-- ------------------------
-- 教师课程关联表（允许重复授课）
-- ------------------------
CREATE TABLE tcourse (
    tno CHAR(30) NOT NULL,              -- 教师编号
    cno INT NOT NULL,                   -- 关联courses表的自增ID
    PRIMARY KEY (tno, cno),
    FOREIGN KEY (tno) REFERENCES teacher(tno),
    FOREIGN KEY (cno) REFERENCES courses(cno)
);

CREATE TABLE IF NOT EXISTS info (
    cno INT NOT NULL,                   -- 关联courses表的自增ID
    cname VARCHAR(30) NOT NULL,         -- 课程名称
    infos VARCHAR(500),                 -- 附加信息（可选）
    cdate DATE,                         -- 记录日期
    PRIMARY KEY (cno, cdate),           -- 防止重复记录
    FOREIGN KEY (cno) REFERENCES courses(cno)
);

-- ------------------------
-- 插入基础数据
-- ------------------------
-- 1. 插入管理员账号
INSERT INTO users (uname, pwd, role) VALUES 
('admin', 'admin', 0);

-- 2. 插入10位教师（tno=0001-0010，随机姓名）
INSERT INTO teacher (tno, tname) VALUES 
('0001', '张明'), ('0002', '李娜'), ('0003', '王宇'), ('0004', '陈芳'),
('0005', '刘伟'), ('0006', '杨丽'), ('0007', '黄凯'), ('0008', '周敏'),
('0009', '吴俊'), ('0010', '郑洁');

-- 插入教师用户账号
INSERT INTO users (uname, pwd, role) VALUES 
('0001', '123456', 1), ('0002', '123456', 1), ('0003', '123456', 1), ('0004', '123456', 1),
('0005', '123456', 1), ('0006', '123456', 1), ('0007', '123456', 1), ('0008', '123456', 1),
('0009', '123456', 1), ('0010', '123456', 1);

-- 3. 插入课程数据（自动生成cno和cno_display）
INSERT INTO courses (cname, credit, max_come, cdate) VALUES 
('C语言程序设计', 4, 30, '2022-2023-1'),
('Java程序设计', 4, 30, '2022-2023-2'),
('离散数学', 3, 30, '2023-2024-1'),
('数据结构', 4, 30, '2023-2024-2'),
('算法设计与分析', 3, 3, '2024-2025-1'),
('数据库原理', 3, 30, '2024-2025-1'),
('计算机网络', 2, 30, '2024-2025-1'),
('操作系统', 4, 30, '2022-2023-1'),
('计算机组成原理', 4, 30, '2022-2023-2'),
('概率论与数理统计', 3, 30, '2024-2025-1'),
('中国近现代史纲要', 3, 30, '2024-2025-1'),
('思想道德与法治', 3, 30, '2024-2025-1'),
('Python程序设计', 4, 3, '2024-2025-1'),
('高等数学', 4, 30, '2024-2025-1'),
('大学物理', 4, 30, '2024-2025-1');

-- 4. 插入学生数据（学号101-126，三位以1开头）
INSERT INTO users (uname, pwd, role) VALUES 
('101', '111222', 2), ('102', '111222', 2), ('103', '111222', 2), ('104', '111222', 2),
('105', '111222', 2), ('106', '111222', 2), ('107', '111222', 2), ('108', '111222', 2),
('109', '111222', 2), ('110', '111222', 2), ('111', '111222', 2), ('112', '111222', 2),
('113', '111222', 2), ('114', '111222', 2), ('115', '111222', 2), ('116', '111222', 2),
('117', '111222', 2), ('118', '111222', 2), ('119', '111222', 2), ('120', '111222', 2),
('121', '111222', 2), ('122', '111222', 2), ('123', '111222', 2), ('124', '111222', 2),
('125', '111222', 2), ('126', '111222', 2);

INSERT INTO student (sno, sname, sex, depart, major, sclass) VALUES 
('101', '张三', '男', '互联网经贸学院', '网络工程', '2302'),
('102', '李四', '男', '互联网经贸学院', '网络工程', '2302'),
('103', '王五', '女', '计算机科学与数学学院', '计算机科学与技术', '2302'),
('104', '赵六', '男', '计算机科学与数学学院', '计算机科学与技术', '2301'),
('105', '孙七', '女', '互联网经贸学院', '电子商务', '2301'),
('106', '周八', '男', '电子信息工程学院', '电子信息工程', '2301'),
('107', '吴九', '男', '互联网经贸学院', '网络工程', '2303'),
('108', '郑十', '女', '计算机科学与数学学院', '计算机科学与技术', '2301'),
('109', '钱十一', '男', '互联网经贸学院', '电子商务', '2302'),
('110', '孙十二', '女', '电子信息工程学院', '电子信息工程', '2303'),
('111', '李十三', '男', '计算机科学与数学学院', '计算机科学与技术', '2301'),
('112', '周十四', '女', '互联网经贸学院', '网络工程', '2302'),
('113', '吴十五', '男', '电子信息工程学院', '电子信息工程', '2303'),
('114', '郑十六', '女', '计算机科学与数学学院', '计算机科学与技术', '2301'),
('115', '王十七', '男', '互联网经贸学院', '电子商务', '2302'),
('116', '赵十八', '女', '电子信息工程学院', '电子信息工程', '2303'),
('117', '钱十九', '男', '计算机科学与数学学院', '计算机科学与技术', '2301'),
('118', '孙二十', '女', '互联网经贸学院', '网络工程', '2302'),
('119', '周二一', '男', '电子信息工程学院', '电子信息工程', '2303'),
('120', '吴二二', '女', '计算机科学与数学学院', '计算机科学与技术', '2301'),
('121', '郑二三', '男', '互联网经贸学院', '电子商务', '2302'),
('122', '王二四', '女', '电子信息工程学院', '电子信息工程', '2303'),
('123', '赵二五', '男', '计算机科学与数学学院', '计算机科学与技术', '2301'),
('124', '钱二六', '女', '互联网经贸学院', '网络工程', '2302'),
('125', '孙二七', '男', '电子信息工程学院', '电子信息工程', '2303'),
('126', '周二八', '女', '计算机科学与数学学院', '计算机科学与技术', '2301');

-- 5. 分配教师授课（使用自动生成的cno）
INSERT INTO tcourse (tno, cno) VALUES 
-- C语言程序设计（0001）由0001和0002授课
('0001', 1), ('0002', 1),
-- Java程序设计（0002）由0003和0004授课
('0003', 2), ('0004', 2),
-- 离散数学（0003）由0005和0006授课
('0005', 3), ('0006', 3),
-- 数据结构（0004）由0007和0008授课
('0007', 4), ('0008', 4),
-- 算法设计与分析（0005）由0001和0003授课
('0001', 5), ('0003', 5),
-- 数据库原理（0006）由0002和0004授课
('0002', 6), ('0004', 6),
-- 计算机网络（0007）由0005和0007授课
('0005', 7), ('0007', 7),
-- 操作系统（0008）由0006和0008授课
('0006', 8), ('0008', 8),
-- 计算机组成原理（0009）由0009和0010授课
('0009', 9), ('0010', 9),
-- 新增选修课教师分配
('0005', 10), ('0006', 10), -- 概率论与数理统计
('0007', 11), ('0008', 11), -- 中国近现代史纲要
('0009', 12), ('0010', 12), -- 思想道德与法治
('0001', 13), ('0002', 13), -- Python程序设计
('0003', 14), ('0004', 14), -- 高等数学
('0005', 15), ('0006', 15); -- 大学物理

-- 6. 生成成绩数据（仅包含2022-2023和2023-2024学年的课程）
INSERT INTO scores (cno, sno, grade, cdate)
SELECT 
    c.cno,                -- 课程编号
    s.sno,                -- 学号
    FLOOR(RAND()*41+60),  -- 随机成绩60-100
    c.cdate                -- 使用课程表中的开课学期
FROM student s
CROSS JOIN courses c
WHERE 
    -- 排除2024-2025学年的课程
    c.cdate NOT LIKE '2024-2025%'
AND NOT EXISTS (            -- 确保同一学生同一课程只选一次
    SELECT 1 FROM scores sc 
    WHERE sc.cno = c.cno AND sc.sno = s.sno
);

-- 测试数据
INSERT INTO student (sno, sname, sex, depart, major, sclass) VALUES 
('228', '林云', '男', '计算机科学与数学学院', '计算机科学与技术', '2301'),
('229', '杨建', '男', '计算机科学与数学学院', '计算机科学与技术', '2302');

INSERT INTO users (uname, pwd, role) VALUES 
('228', '111222', 2),
('229', '111222', 2);

-- 验证课程编号生成
SELECT cno,  cname FROM courses ORDER BY cno;